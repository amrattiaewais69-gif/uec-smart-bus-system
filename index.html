<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>University of East Capital - Bus System</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  font-family: 'Segoe UI', sans-serif;
  background:#0a1a2f;
  color:white;
  text-align:center;
}

header{
  padding:20px;
  font-size:28px;
  font-weight:bold;
  color:#d4af37;
  border-bottom:3px solid #d4af37;
}

.container{
  padding:20px;
}

input, select{
  padding:10px;
  margin:10px;
  border-radius:8px;
  border:none;
  width:220px;
  font-size:16px;
}

button{
  padding:12px 25px;
  border:none;
  border-radius:8px;
  background:#d4af37;
  color:#0a1a2f;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}

button:hover{
  transform:scale(1.05);
}

#reader{
  width:300px;
  margin:20px auto;
}

#status{
  margin-top:20px;
  font-size:20px;
  font-weight:bold;
}

.counter{
  margin-top:10px;
  font-size:18px;
  color:#d4af37;
}

footer{
  margin-top:40px;
  padding:15px;
  font-size:14px;
  border-top:2px solid #d4af37;
  color:#ccc;
}
</style>
</head>

<body>

<header>
University of East Capital<br>
Bus Attendance System
</header>

<div class="container">

<div id="loginSection">
  <h3>Driver Login</h3>
  <input type="text" id="driver" placeholder="Driver Name" required><br>
  <input type="text" id="bus" placeholder="Bus Number" required><br>
  <button onclick="startSystem()">Start System</button>
</div>

<div id="scanSection" style="display:none;">
  <h3 id="sessionInfo"></h3>
  <div id="reader"></div>
  <div id="status"></div>
  <div class="counter">Students Count: <span id="count">0</span></div>
</div>

</div>

<footer>
Designed by UEC ICT Department<br>
Â© 2026 University of East Capital. All Rights Reserved.
</footer>

<script>

const scriptURL = "https://script.google.com/macros/s/AKfycbw-G-TCGtuBDT-TbOE3Lrs9toH48WHhL2NWq6wi183qlICL7Ypmt_1R21L_elNfq4rl/exec";

let studentCount = 0;
let qr;

function startSystem(){
  const driver = document.getElementById("driver").value;
  const bus = document.getElementById("bus").value;

  if(!driver || !bus){
    alert("Enter Driver Name and Bus Number");
    return;
  }

  document.getElementById("loginSection").style.display="none";
  document.getElementById("scanSection").style.display="block";
  document.getElementById("sessionInfo").innerHTML =
    "Driver: "+driver+" | Bus: "+bus+"<br>"+new Date().toLocaleString();

  qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

async function onScanSuccess(decodedText){

  const driver = document.getElementById("driver").value;
  const bus = document.getElementById("bus").value;

  let data;

  try{
    data = JSON.parse(decodedText);
  }catch(e){
    document.getElementById("status").innerHTML="Invalid QR Format";
    playBeep("error");
    return;
  }

  const response = await fetch(scriptURL,{
    method:"POST",
    body: JSON.stringify({
      studentId: data.id,
      studentName: data.name,
      college: data.college,
      driverName: driver,
      busNumber: bus
    })
  });

  const result = await response.json();

  document.getElementById("status").innerHTML =
    result.status.toUpperCase()+"<br>"+result.message;

  if(result.status === "approved"){
    studentCount++;
    document.getElementById("count").innerText = studentCount;
    playBeep("success");
  }else{
    playBeep("error");
  }
}

/* ðŸ”Š Sound System (Guaranteed Working) */

function playBeep(type){
  const context = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = context.createOscillator();
  const gainNode = context.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(context.destination);

  if(type === "success"){
    oscillator.frequency.value = 900;
  } else {
    oscillator.frequency.value = 300;
  }

  oscillator.type = "sine";
  oscillator.start();

  gainNode.gain.setValueAtTime(1, context.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.5);

  oscillator.stop(context.currentTime + 0.5);
}

</script>

</body>
</html>
