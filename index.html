<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>University of East Capital - Bus System</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#0a1a2f;
  color:white;
  text-align:center;
}

header{
  padding:20px;
  font-size:28px;
  font-weight:bold;
  color:#d4af37;
  border-bottom:3px solid #d4af37;
  letter-spacing:1px;
}

.bus-icon{
  font-size:50px;
  margin-top:10px;
  animation: floatBus 3s ease-in-out infinite;
}

@keyframes floatBus{
  0%{ transform:translateY(0px); }
  50%{ transform:translateY(-8px); }
  100%{ transform:translateY(0px); }
}

.container{ padding:20px; }

input{
  padding:10px;
  margin:10px;
  border-radius:8px;
  border:none;
  width:220px;
  font-size:16px;
}

button{
  padding:12px 25px;
  border:none;
  border-radius:8px;
  background:#d4af37;
  color:#0a1a2f;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}

button:hover{ transform:scale(1.05); }

#reader{
  width:300px;
  margin:20px auto;
  border:3px solid #d4af37;
  border-radius:12px;
  padding:10px;
  box-shadow:0 0 15px rgba(212,175,55,0.6);
  transition:0.3s;
}

#reader.approved-glow{
  box-shadow:0 0 30px #00ff88;
}

#reader.error-glow{
  box-shadow:0 0 30px #ff4444;
}

#status{
  margin-top:20px;
  font-size:22px;
  font-weight:bold;
  min-height:60px;
}

.counter{
  margin-top:10px;
  font-size:18px;
  color:#d4af37;
}

footer{
  margin-top:40px;
  padding:15px;
  font-size:14px;
  border-top:2px solid #d4af37;
  color:#ccc;
}

#resultOverlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  font-weight:bold;
  color:white;
  opacity:0;
  pointer-events:none;
  transition:0.4s;
  z-index:9999;
  text-align:center;
}

#resultOverlay.show{ opacity:1; }

#resultOverlay.approved{
  background:linear-gradient(135deg,#0f5132,#198754);
}

#resultOverlay.rejected{
  background:linear-gradient(135deg,#5a0f0f,#a71d2a);
}
</style>
</head>

<body>

<header>
University of East Capital<br>
Bus Attendance System
<div class="bus-icon">ðŸšŒ</div>
</header>

<div class="container">

<div id="loginSection">
  <h3>Driver Login</h3>
  <input type="text" id="driver" placeholder="Driver Name"><br>
  <input type="text" id="bus" placeholder="Bus Number"><br>
  <button onclick="startSystem()">Start System</button>
</div>

<div id="scanSection" style="display:none;">
  <h3 id="sessionInfo"></h3>
  <div id="reader"></div>
  <div id="status"></div>
  <div class="counter">Students Count: <span id="count">0</span></div>
</div>

</div>

<footer>
Designed by UEC ICT Department<br>
Â© 2026 University of East Capital. All Rights Reserved.
</footer>

<div id="resultOverlay"></div>

<script>

const scriptURL = "https://script.google.com/macros/s/AKfycbw-G-TCGtuBDT-TbOE3Lrs9toH48WHhL2NWq6wi183qlICL7Ypmt_1R21L_elNfq4rl/exec";

let studentCount = 0;
let qr;
let isProcessing = false;
let lastScannedId = null;

function startSystem(){

  const driver = document.getElementById("driver").value;
  const bus = document.getElementById("bus").value;

  if(!driver || !bus){
    alert("Enter Driver Name and Bus Number");
    return;
  }

  document.getElementById("loginSection").style.display="none";
  document.getElementById("scanSection").style.display="block";

  document.getElementById("sessionInfo").innerHTML =
    "Driver: "+driver+" | Bus: "+bus+"<br>"+new Date().toLocaleString();

  qr = new Html5Qrcode("reader");

  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

async function onScanSuccess(decodedText){

  if(isProcessing) return;

  let data;

  try{
    data = JSON.parse(decodedText);
  }catch(e){
    playError();
    return;
  }

  if(data.id === lastScannedId){
    return;
  }

  isProcessing = true;
  lastScannedId = data.id;

  qr.pause();

  const driver = document.getElementById("driver").value;
  const bus = document.getElementById("bus").value;

  try{

    const response = await fetch(scriptURL,{
      method:"POST",
      body: JSON.stringify({
        studentId: data.id,
        studentName: data.name,
        college: data.college,
        driverName: driver,
        busNumber: bus
      })
    });

    const result = await response.json();

    document.getElementById("status").innerHTML =
      result.status.toUpperCase()+"<br>"+result.message;

    showOverlay(result.status, result.message);

    if(result.status === "approved"){
      studentCount++;
      document.getElementById("count").innerText = studentCount;
      playSuccess();
    }else{
      playError();
    }

  }catch(error){
    document.getElementById("status").innerHTML="Connection Error";
    playError();
  }

  setTimeout(()=>{
    qr.resume();
    isProcessing = false;
  },2000);
}

function showOverlay(type, message){

  const overlay = document.getElementById("resultOverlay");
  overlay.className="";
  overlay.classList.add("show");
  overlay.classList.add(type);
  overlay.innerHTML = type.toUpperCase()+"<br>"+message;

  if(type === "approved"){
    document.getElementById("reader").classList.add("approved-glow");
  }else{
    document.getElementById("reader").classList.add("error-glow");
  }

  setTimeout(()=>{
    overlay.className="";
    document.getElementById("reader").classList.remove("approved-glow","error-glow");
  },1500);
}

function playSuccess(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const now = ctx.currentTime;

  const o1 = ctx.createOscillator();
  const g1 = ctx.createGain();

  o1.type="sine";
  o1.frequency.setValueAtTime(880,now);
  o1.connect(g1);
  g1.connect(ctx.destination);
  g1.gain.setValueAtTime(0.0001,now);
  g1.gain.exponentialRampToValueAtTime(0.5,now+0.05);
  g1.gain.exponentialRampToValueAtTime(0.0001,now+0.6);
  o1.start(now);
  o1.stop(now+0.6);

  if(navigator.vibrate){ navigator.vibrate([80]); }
}

function playError(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const now = ctx.currentTime;

  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type="sawtooth";
  o.frequency.setValueAtTime(200,now);
  o.connect(g);
  g.connect(ctx.destination);
  g.gain.setValueAtTime(0.0001,now);
  g.gain.exponentialRampToValueAtTime(0.4,now+0.05);
  g.gain.exponentialRampToValueAtTime(0.0001,now+0.8);
  o.start(now);
  o.stop(now+0.8);

  if(navigator.vibrate){ navigator.vibrate([200,100,200]); }
}

</script>

</body>
</html>
